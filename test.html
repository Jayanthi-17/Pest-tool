<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plant Pest Diagnostic Tool</title>
</head>
<body>
    <div id="CalculatorContainer"></div>

    <script>
        const pestData = [
            // Your pest data remains the same (I've truncated it for brevity)
            {
                name: "Anthracnose",
                type: "Disease (Fungal)",
                plants: ["Beans", "Cucumbers", "Melons", "Peppers", "Tomatoes"],
                affectedParts: ["Leaves", "Stems", "Fruit"],
                symptoms: [
                {part:"Leaves",description:"Dark spots or blotches"},
                {part:"Leaves",description:"Yellowing around spots"},
                {part:"Leaves",description:"Curling or distorted leaves"},
                {part:"Leaves",description:"Premature leaf drop"},
                {part:"Stems",description: "Dark or sunken areas on stems"},
                {part:"Stems",description: "Tips of branches may die back"},
                {part:"Fruit",description: "Dark or sunken spots or patches on fruit"}
                ],
                prevention: ["Avoid overhead watering", "Improve air circulation", "Rotate crops", "Plant resistant varieties"],
                control: ["Prune infected areas", "Apply copper or sulfur-based fungicides early", "Destroy fallen debris"],
                link: "https://www.almanac.com/pest/anthracnose",
                image: "https://www.almanac.com/sites/default/files/styles/or/public/image_nodes/control-voles-in-garden.jpg",
                caption: "Image courtesy: [Photographer/Credit]"
            },
            {
                name: "Aphids",
                type: "Insect (Sap-sucking pest)",
                plants: ["Beets", "Beans", "Cucumbers", "Gladioli", "Impatiens", "Lettuce", "Melons", "Petunias", "Phlox", "Pumpkins", "Rudbeckias", "Spinach", "Squashes", "Tomatoes"],
                affectedParts: ["Leaves", "Stems", "Flowers", "Buds"],
                symptoms: [
                {part:"Leaves",description:"Curled or distorted leaves"},
                {part:"Leaves",description: "Sticky residue (honeydew) on leaves"},
                {part:"Leaves",description:"Yellow leaves"},
                {part:"Stems",description: "Clusters of tiny insects"},
                {part:"Stems",description:"Sticky residue on stems"},
                {part:"Stems",description:"Stunted growth or weakened shoots"},
                {part:"Flowers",description:"Deformed petals"},
                {part:"Flowers",description:"Flowers may drop early"},
                {part:"Buds",description:"Distorted buds"},
                {part:"Buds",description:"Buds fail to open"}
                ],
                prevention: ["Monitor regularly", "Avoid over-fertilizing", "Encourage beneficial insects such as ladybugs or lacewings", "Remove weeds nearby","Ants tend to be attracted to the honeydew left by aphids, so ant activity can often lead you to aphid colonies."],
                control: ["Use a high pressure spray from the garden hose", "Follow up with two applications of insecticidal soap, one week apart", "Be sure to apply the soap spray to leaf undersides and crevices.", "Aphids are prey for many beneficial insectsâ€”use chemical controls only when populations are high and damage is visible"],
                link: "https://www.almanac.com/pest/aphids",
                image: "https://www.almanac.com/sites/default/files/styles/or/public/image_nodes/control-voles-in-garden.jpg",
                caption: "Image courtesy: [Photographer/Credit]"
            },
            // ... rest of your pest data ...
        ];

        // Function to create and inject the CSS
        function injectStyles() {
            const style = document.createElement('style');
            style.textContent = `
                /* Your existing CSS styles remain the same */
                #CalculatorContainer * {
                    box-sizing: border-box;
                    margin: 0;
                    padding: 0;
                    font-family: 'Georgia', serif; 
                }
                
                #CalculatorContainer {
                    padding: 20px;
                    display: flex;
                    justify-content: center;
                }
                
                /* ... rest of your CSS styles ... */
            `;
            document.head.appendChild(style);
        }

        // Function to create the HTML structure
        function createHTMLStructure() {
            const calculatorContainer = document.getElementById('CalculatorContainer');
            
            calculatorContainer.innerHTML = `
                <div class="container">
                    <header>
                        <h1>Plant Pest Diagnostic Tool</h1>
                        <p class="description">Identify pests and diseases affecting your plants by selecting your plant type, problem area, and symptoms</p>
                    </header>
                    
                    <div class="step">
                        <h2 class="step-title">Step 1: Select a Plant</h2>
                        <div class="form-group">
                            <label for="plant-select">Choose a plant:</label>
                            <select id="plant-select">
                                <option value="">-- Select a plant --</option>
                                <!-- Plant options will be populated by JavaScript -->
                            </select>
                        </div>
                    </div>
                    
                    <div class="step" id="problem-area-step" style="display: none;">
                        <h2 class="step-title">Step 2: Select Problem Area</h2>
                        <div class="form-group">
                            <label for="problem-area-select">Where is the problem located?</label>
                            <select id="problem-area-select">
                                <option value="">-- Select problem area --</option>
                                <!-- Problem area options will be populated by JavaScript -->
                            </select>
                        </div>
                    </div>
                    
                    <div class="step" id="symptoms-step" style="display: none;">
                        <h2 class="step-title">Step 3: Select Symptoms</h2>
                        <div class="symptoms-container" id="symptoms-container">
                            <!-- Symptoms will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div class="step" id="additional-symptoms-step" style="display: none;">
                        <h2 class="step-title">Step 4: Select Additional Symptom</h2>
                        <div class="additional-symptom-note">
                            Your first symptom matched several pests. Please select an additional symptom to narrow down the results.
                        </div>
                        <div class="symptoms-container" id="additional-symptoms-container">
                            <!-- Additional symptoms will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div class="result" id="result">
                        <h3>Diagnosis Result</h3>
                        <div class="pest-info" id="pest-info">
                            <!-- Pest information will be populated by JavaScript -->
                        </div>
                        <br>
                        <button class="reset-btn" onclick="resetTool()">Start Over</button>
                    </div>
                </div>
            `;
        }

        // Extract all unique plants from pest data
        const allPlants = [...new Set(pestData.flatMap(pest => pest.plants))].sort();

        // DOM elements
        let plantSelectEl, problemAreaStepEl, problemAreaSelectEl, symptomsStepEl, symptomsContainerEl;
        let additionalSymptomsStepEl, additionalSymptomsContainerEl, resultEl, pestInfoEl;

        // State variables
        let selectedPlant = null;
        let selectedProblemArea = null;
        let filteredPests = [];
        let firstSymptom = null;
        let firstSymptomPests = [];

        // Initialize the tool
        function initTool() {
            plantSelectEl = document.getElementById('plant-select');
            problemAreaStepEl = document.getElementById('problem-area-step');
            problemAreaSelectEl = document.getElementById('problem-area-select');
            symptomsStepEl = document.getElementById('symptoms-step');
            symptomsContainerEl = document.getElementById('symptoms-container');
            additionalSymptomsStepEl = document.getElementById('additional-symptoms-step');
            additionalSymptomsContainerEl = document.getElementById('additional-symptoms-container');
            resultEl = document.getElementById('result');
            pestInfoEl = document.getElementById('pest-info');

            // Populate plant select options
            allPlants.forEach(plant => {
                const option = document.createElement('option');
                option.value = plant;
                option.textContent = plant;
                plantSelectEl.appendChild(option);
            });

            // Event listeners
            plantSelectEl.addEventListener('change', handlePlantChange);
            problemAreaSelectEl.addEventListener('change', handleProblemAreaChange);
        }

        // Plant change handler
        function handlePlantChange() {
            selectedPlant = plantSelectEl.value;

            if (selectedPlant) {
                problemAreaStepEl.style.display = 'block';
                problemAreaSelectEl.innerHTML = '<option value="">-- Select problem area --</option>';

                let affectedPartsForPlant = [...new Set(pestData
                    .filter(pest => pest.plants.includes(selectedPlant))
                    .flatMap(pest => pest.affectedParts))].sort();

                // Remove duplicates
                affectedPartsForPlant = [...new Set(affectedPartsForPlant)].sort();

                affectedPartsForPlant.forEach(part => {
                    const option = document.createElement('option');
                    option.value = part;
                    option.textContent = part;
                    problemAreaSelectEl.appendChild(option);
                });

                problemAreaStepEl.scrollIntoView({ behavior: 'smooth' });
                symptomsStepEl.style.display = 'none';
                additionalSymptomsStepEl.style.display = 'none';
                resultEl.style.display = 'none';
                symptomsContainerEl.innerHTML = '';
                additionalSymptomsContainerEl.innerHTML = '';
            } else {
                problemAreaStepEl.style.display = 'none';
                symptomsStepEl.style.display = 'none';
                additionalSymptomsStepEl.style.display = 'none';
                resultEl.style.display = 'none';
                symptomsContainerEl.innerHTML = '';
                additionalSymptomsContainerEl.innerHTML = '';
            }
        }

        // Problem area change handler
        function handleProblemAreaChange() {
            selectedProblemArea = problemAreaSelectEl.value;

            if (selectedProblemArea) {
                // Filter pests based on selected plant and problem area
                filteredPests = pestData.filter(pest =>
                    pest.plants.includes(selectedPlant) &&
                    pest.affectedParts.includes(selectedProblemArea)
                );

                symptomsStepEl.style.display = 'block';
                symptomsContainerEl.innerHTML = '';

                if (filteredPests.length === 0) {
                    symptomsContainerEl.innerHTML = '<div class="no-results">No symptoms found for this combination.</div>';
                    return;
                }

                // Get all symptoms for the selected problem area from filtered pests
                const allSymptoms = [];
                filteredPests.forEach(pest => {
                    pest.symptoms.forEach(symptom => {
                        if (symptom.part === selectedProblemArea) {
                            // Check if this symptom is already in our list
                            const isDuplicate = allSymptoms.some(s => 
                                s.part === symptom.part && s.description === symptom.description
                            );
                            
                            if (!isDuplicate) {
                                allSymptoms.push(symptom);
                            }
                        }
                    });
                });

                if (allSymptoms.length === 0) {
                    symptomsContainerEl.innerHTML = '<div class="no-results">No symptoms found for this problem area.</div>';
                    return;
                }

                // Sort symptoms alphabetically by description
                allSymptoms.sort((a, b) => a.description.localeCompare(b.description));

                // Display symptoms in a scrollable container
                allSymptoms.forEach(symptom => {
                    const symptomOption = document.createElement('div');
                    symptomOption.className = 'symptom-option';

                    const radio = document.createElement('input');
                    radio.type = 'radio';
                    radio.name = 'symptom';
                    radio.value = symptom.description;
                    radio.id = `symptom-${symptom.description.replace(/\s+/g, '-').toLowerCase()}`;
                    
                    // MODIFIED: Use a more dynamic event listener
                    radio.addEventListener('change', function() {
                        if (this.checked) {
                            handleSymptomChange(symptom.description);
                        }
                    });

                    const label = document.createElement('label');
                    label.htmlFor = radio.id;
                    label.textContent = symptom.description;

                    symptomOption.appendChild(radio);
                    symptomOption.appendChild(label);
                    symptomsContainerEl.appendChild(symptomOption);
                });

                symptomsStepEl.scrollIntoView({ behavior: 'smooth' });
                additionalSymptomsStepEl.style.display = 'none';
                resultEl.style.display = 'none';
                pestInfoEl.innerHTML = '';
            } else {
                symptomsStepEl.style.display = 'none';
                additionalSymptomsStepEl.style.display = 'none';
                resultEl.style.display = 'none';
                symptomsContainerEl.innerHTML = '';
                additionalSymptomsContainerEl.innerHTML = '';
            }
        }

        // Symptom change handler - find all pests for selected symptom
        function handleSymptomChange(selectedSymptom) {
            // Clear any previous additional symptom selections
            clearAdditionalSymptoms();
            
            const matchingPests = filteredPests.filter(pest => 
                pest.symptoms.some(symptom => 
                    symptom.part === selectedProblemArea && symptom.description === selectedSymptom
                )
            );

            // NEW LOGIC: If more than 3 pests match, ask for additional symptom
            if (matchingPests.length > 3) {
                firstSymptom = selectedSymptom;
                firstSymptomPests = matchingPests;
                
                // Show additional symptom selection
                showAdditionalSymptoms(matchingPests);
            } else {
                // If 3 or fewer pests, display results immediately
                displayPestResults(matchingPests);
            }
        }

        // Clear additional symptoms when main symptom changes
        function clearAdditionalSymptoms() {
            additionalSymptomsStepEl.style.display = 'none';
            additionalSymptomsContainerEl.innerHTML = '';
            firstSymptom = null;
            firstSymptomPests = [];
            
            // Clear any selected additional symptoms
            const additionalRadios = document.querySelectorAll('input[name="additional-symptom"]');
            additionalRadios.forEach(radio => radio.checked = false);
        }

        // Show additional symptoms for narrowing down results
        function showAdditionalSymptoms(pests) {
            additionalSymptomsStepEl.style.display = 'block';
            additionalSymptomsContainerEl.innerHTML = '';

            // Get all symptoms from the pests that matched the first symptom
            const allSymptoms = [];
            pests.forEach(pest => {
                pest.symptoms.forEach(symptom => {
                    if (symptom.part === selectedProblemArea && symptom.description !== firstSymptom) {
                        // Check if this symptom is already in our list
                        const isDuplicate = allSymptoms.some(s => 
                            s.part === symptom.part && s.description === symptom.description
                        );
                        
                        if (!isDuplicate) {
                            allSymptoms.push(symptom);
                        }
                    }
                });
            });

            if (allSymptoms.length === 0) {
                // If no additional symptoms available, just show the results
                displayPestResults(pests);
                return;
            }

            // Sort symptoms alphabetically by description
            allSymptoms.sort((a, b) => a.description.localeCompare(b.description));

            // Display symptoms in a scrollable container
            allSymptoms.forEach(symptom => {
                const symptomOption = document.createElement('div');
                symptomOption.className = 'symptom-option';

                const radio = document.createElement('input');
                radio.type = 'radio';
                radio.name = 'additional-symptom';
                radio.value = symptom.description;
                radio.id = `additional-symptom-${symptom.description.replace(/\s+/g, '-').toLowerCase()}`;
                
                // MODIFIED: Use a more dynamic event listener
                radio.addEventListener('change', function() {
                    if (this.checked) {
                        handleAdditionalSymptomChange(symptom.description);
                    }
                });

                const label = document.createElement('label');
                label.htmlFor = radio.id;
                label.textContent = symptom.description;

                symptomOption.appendChild(radio);
                symptomOption.appendChild(label);
                additionalSymptomsContainerEl.appendChild(symptomOption);
            });

            additionalSymptomsStepEl.scrollIntoView({ behavior: 'smooth' });
            resultEl.style.display = 'none';
            pestInfoEl.innerHTML = '';
        }

        // Handle additional symptom selection
        function handleAdditionalSymptomChange(additionalSymptom) {
            // Find pests that match BOTH the first symptom and the additional symptom
            const finalMatchingPests = firstSymptomPests.filter(pest => 
                pest.symptoms.some(symptom => 
                    symptom.part === selectedProblemArea && symptom.description === additionalSymptom
                )
            );

            // Display the final results
            displayPestResults(finalMatchingPests);
        }

        // Display pest results
        function displayPestResults(matchingPests) {
            if (matchingPests.length > 0) {
                pestInfoEl.innerHTML = ''; // Clear previous results
                
                matchingPests.forEach(pest => {
                    // Format symptoms for display
                    const formattedSymptoms = pest.symptoms
                        .filter(symptom => symptom.part === selectedProblemArea)
                        .map(symptom => symptom.description)
                        .join('; ');

                    // Create pest info with image for each pest
                    const pestElement = document.createElement('div');
                    pestElement.className = 'pest-item';
                    pestElement.innerHTML = `
                        <div class="pest-header">
                            <div>
                                <div class="pest-name">${pest.name}</div>
                                <div class="pest-type">${pest.type}</div>
                            </div>   
                        </div>
                        <img class="pest-image" src="${pest.image}" alt="${pest.name}">
                        ${pest.caption ? `<div class="pest-caption">${pest.caption}</div>` : ""}
                        
                        <div class="pest-detail"><strong>Plants Affected:</strong> ${pest.plants.join(', ')}</div>
                        <div class="pest-detail"><strong>Affected Parts:</strong> ${pest.affectedParts.join(', ')}</div>
                        <div class="pest-detail"><strong>Symptoms:</strong> ${formattedSymptoms}</div>
                        ${pest.prevention ? `<div class="pest-detail"><strong>Prevention:</strong> ${Array.isArray(pest.prevention) ? pest.prevention.join('; ') : pest.prevention}</div>` : ''}
                        ${pest.control ? `<div class="pest-detail"><strong>Control:</strong> ${Array.isArray(pest.control) ? pest.control.join('; ') : pest.control}</div>` : ''}
                        ${pest.link && pest.link !== "n/a" ? `<a href="${pest.link}" class="pest-link" target="_blank">Learn More About This Pest</a>` : ''}
                        <hr>
                    `;
                    
                    pestInfoEl.appendChild(pestElement);
                });

                resultEl.style.display = 'block';
                resultEl.scrollIntoView({ behavior: 'smooth' });
            } else {
                pestInfoEl.innerHTML = '<div class="no-results">No pests found matching your selection. Please try different symptoms.</div>';
                resultEl.style.display = 'block';
            }
        }

        // Reset tool state and UI
        function resetTool() {
            selectedPlant = null;
            selectedProblemArea = null;
            filteredPests = [];
            firstSymptom = null;
            firstSymptomPests = [];

            plantSelectEl.value = '';
            problemAreaSelectEl.value = '';
            symptomsContainerEl.innerHTML = '';
            additionalSymptomsContainerEl.innerHTML = '';

            const radios = document.querySelectorAll('input[name="symptom"]');
            radios.forEach(radio => radio.checked = false);

            const additionalRadios = document.querySelectorAll('input[name="additional-symptom"]');
            additionalRadios.forEach(radio => radio.checked = false);

            problemAreaStepEl.style.display = 'none';
            symptomsStepEl.style.display = 'none';
            additionalSymptomsStepEl.style.display = 'none';
            resultEl.style.display = 'none';

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // On window load initialize everything
        window.onload = function () {
            injectStyles();
            createHTMLStructure();
            initTool();
        };
    </script>
</body>
</html>